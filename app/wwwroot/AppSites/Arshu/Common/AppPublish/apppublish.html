
<script type="text/javascript">

    window.ajaxid = 0;

    function hideAppDomainPublisher() {
        let modal = document.querySelector('#publishAppDomain');
        modal.classList.remove('is-active');
    }

    function showAppDomainPublisher(progressElmId) {
        let modal = document.querySelector('#publishAppDomain');
        modal.classList.add('is-active');
    }

    function publishAppDomain(progressElmId, responseElmId, publishAppSitesListElmName, htmlOutputFolderName, optimizeHtml, mergeJs, mergeCss, mergeUrl, mergeImg, clearAllBeforePublish, successCallback) {

        let id = window.ajaxid++;

        let responseContainerElmId = responseElmId + "Container";
        let responseElm = getElm(responseElmId)
        let responseContainerElm = getElm(responseContainerElmId)
        while (responseElm.firstChild) responseElm.removeChild(responseElm.firstChild);
        hideElm(responseContainerElmId);

        let valid = true;

        const publishAppSites = [];
        let appSiteCheckboxList = document.getElementsByName(publishAppSitesListElmName);
        for (let y = 0; y < appSiteCheckboxList.length; y++) {
            if (appSiteCheckboxList[y].checked == true) {
                publishAppSites.push(appSiteCheckboxList[y].defaultValue);
            }
        }

        if (publishAppSites.length == 0) {
            showText(responseElm, 'Select AppSite(s) to Publish', 'red');
            valid = false;
        }

        if (htmlOutputFolderName.length === 0) {
            showText(responseElm, 'Enter Html Output Folder Name', 'red');
            valid = false;
        }

        if (valid == true) {

            let url = '/AppApi/AppApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": "PublishAppDomain",
                "params": {
                    "publishAppSites": publishAppSites,
                    "outputFolderName": htmlOutputFolderName,
                    "optimizeHtml": optimizeHtml,
                    "mergeJs": mergeJs,
                    "mergeCss": mergeCss,
                    "mergeUrl": mergeUrl,
                    "mergeImg": mergeImg,
                    "clearAllBeforePublish": clearAllBeforePublish
                },
                "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if ((data.hasOwnProperty('Result') === true) && (data.Result)) {
                        let result = data.Result;

                        if (result.hasOwnProperty('message') === true) {
                            showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('json') === true) {
                                let jsonTagList = result.json;
                                for (let i = 0; i < jsonTagList.length; i++) {
                                    let jsonTag = jsonTagList[i];
                                    for (let key in jsonTag) {
                                        if (jsonTag.hasOwnProperty(key)) {
                                            let tagNode = getElm(key);
                                            if (tagNode) {
                                                tagNode.outerHTML = jsonTag[key];
                                                //tagNode.style.display = "block";
                                            }
                                        }
                                    }
                                }
                            }

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        else if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                    }
                    else if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        let error = data.Error;
                        if (error.hasOwnProperty('Message') === true) {
                            showText(responseElm, error.Message, 'red');
                        }
                    }
                });
        }

    }

</script>

<div class="modal" id="publishAppDomain">
    <div class="modal-background"></div>
    <div class="modal-content">

        <div class="flex-content-wrap" style="padding:3px 10px;background-color:#fff;">
            <div class="flex-item-stretch"></div>
            <button class="border" style="margin-top:7px;width:25px;height:25px;background-color: lightgray;" onclick="hideAppDomainPublisher()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        {{PublishAppSitesList}}

        <div class="flex-content-wrap" style="padding:3px 10px;background-color:#fff;">
            <div style="width:100%;text-align:center">Root Folder</div>
            <input type="text" id="currentWebRootFolderName" class="border flex-item-stretch" style="width:100%;" placeholder="Enter Root Folder" value="{{$RootFolder}}" readonly>
        </div>

        <div class="flex-content-wrap" style="padding:3px 10px;background-color:#fff;">
            <div style="width:100%;text-align:center">Publish Folder</div>
            <input type="text" id="htmlOutputFolderName" class="border flex-item-stretch" style="width:100%;" placeholder="Enter Publish Folder" value="wwwhtml">
        </div>

        <div class="flex-content-wrap" style="padding:3px 10px;background-color:#fff;">
            <div style="width:100%;text-align:center;">
                <label style="text-align:center;display:inline-block;">
                    <input type="checkbox"
                           id="optimizeHtml"
                           checked="checked">&nbsp;Optimize Html
                </label>
                <label style="text-align:center;display:inline-block;">
                    <input type="checkbox"
                           id="mergeJs">&nbsp;Embed Js
                </label>
                <label style="text-align:center;display:inline-block;">
                    <input type="checkbox"
                           id="mergeCss">&nbsp;Embed Css
                </label>
                <label style="text-align:center;display:inline-block;">
                    <input type="checkbox"
                           id="mergeUrl">&nbsp;Embed Url (Font/Image)
                </label>
                <label style="text-align:center;display:inline-block;">
                    <input type="checkbox"
                           id="mergeImg">&nbsp;Embed Image
                </label>
            </div>
        </div>

        <div class="flex-content-wrap" style="padding:3px 10px;background-color:#fff;">
            <div style="width:100%;text-align:center;">
                <label style="text-align:center;display:inline-block;">
                    <input type="checkbox"
                           id="clearAllBeforePulish">&nbsp;Clear All Before Publish
                </label>
            </div>
        </div>

        <div class="flex-content-wrap" style="padding: 3px 10px;background-color:#fff;">

            <button class="border button" style="background-color:#209cee;margin-right:5px;"
                    onclick="publishAppDomain('publishProgress', 'publishResponse', 'publishAppSitesList', getElm('htmlOutputFolderName').value,  getElm('optimizeHtml').checked, getElm('mergeJs').checked, getElm('mergeCss').checked, getElm('mergeUrl').checked, getElm('mergeImg').checked, getElm('clearAllBeforePulish').checked, function () { triggerEvent('refreshFromAppDomainListBtn', 'click'); });">
                Publish App Domain<div id="publishProgress"></div>
            </button>

            <div class="notification" id="publishResponseContainer" style="margin:5px; padding:10px;text-align:justify;display:none;width:100%;">
                <button class="delete" onclick="hideElm('publishResponseContainer')"></button>
                <div id="publishResponse"></div>
            </div>

        </div>

        {{AppDomainSwitch}}

    </div>
</div>
