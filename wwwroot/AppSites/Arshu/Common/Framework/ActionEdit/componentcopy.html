
<script type="text/javascript">

    window.ajaxid = 0;

    function hideComponentSourceCopy() {

        let modal = document.querySelector('#copyComponentSource');
        modal.classList.remove('is-active');
    }

    function showComponentSourceCopy(progressElmId, componentAppSite, componentAppView, sourceComponentId, reloadData) {

        getElm('sourceComponentId').value = sourceComponentId;
        getElm('sourceComponentTitle').textContent = sourceComponentId + " Components";

        getElm('copyComponentAppSite').value = componentAppSite;
        getElm('copyComponentAppView').value = componentAppView;

        if ((getElm('selectMainComponent').options.length <= 1) || (reloadData === true)) {
            getViewComponentHierarchy(progressElmId, 'copyComponentSourceResponse', componentAppSite, componentAppView, sourceComponentId, 'selectMainComponent', function () {

                let componentCount = getElm('selectNewComponent').options.length;
                if (componentCount <= 1) {
                    let fromComponentAppSiteVal = getElm('selectNewComponentAppSite').value
                    getViewComponentCategoryList(progressElmId, 'copyComponentSourceResponse', fromComponentAppSiteVal, 'selectNewComponentCategory', function () {
                        let componentCategoryCount = getElm('selectNewComponentCategory').options.length;
                        if (componentCategoryCount > 0) {
                            let fromComponentCategoryVal = getElm('selectNewComponentCategory').value;
                            getViewComponentList(progressElmId, 'copyComponentSourceResponse', fromComponentAppSiteVal, fromComponentCategoryVal, 'selectNewComponent', function () {
                                let modal = document.querySelector('#copyComponentSource');
                                modal.classList.add('is-active');
                            });
                        } else {
                            let modal = document.querySelector('#copyComponentSource');
                            modal.classList.add('is-active');
                        }
                    });
                } else {
                    let modal = document.querySelector('#copyComponentSource');
                    modal.classList.add('is-active');
                }
            });
        } else {
            let modal = document.querySelector('#copyComponentSource');
            modal.classList.add('is-active');
        }
    }

    function getViewComponentHierarchy(progressElmId, responseElmId, componentAppSite, componentAppView, sourceComponentName, targetSelectElmId, successCallback) {

        let id = window.ajaxid++;
        let responseContainerElmId = responseElmId + "Container";
        let responseElm = getElm(responseElmId);
        while (responseElm.firstChild) responseElm.removeChild(responseElm.firstChild);
        let responseContainerElm = getElm(responseContainerElmId)
        hideElm(responseContainerElmId);

        let valid = true;

        let currentSelectedVal = getElm(targetSelectElmId).value;

        if (valid === true) {

            let url = '/AppApi/VueApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'GetViewComponentHierarchy',
                "params": {
                    "componentAppSite": componentAppSite,
                    "componentAppView": componentAppView,
                    "componentName": sourceComponentName,
                },
                "id": id
            };

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (((data.hasOwnProperty('Result') === true) && (data.Result)) && (data.Result)) {
                        let result = data.Result;

                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                        else if (result.hasOwnProperty('message') === true) {
                            //showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('json') === true) {
                                let json = result.json;

                                let selectElm = getElm(targetSelectElmId);
                                if (selectElm) {
                                    selectElm.options.length = 0;

                                    for (let i = 0; i < json.length; i++) {
                                        let jsonSource = json[i];

                                        let selectText = "";
                                        let selectValue = "";
                                        for (let key in jsonSource) {
                                            selectText = key;
                                            selectValue = jsonSource[key];
                                        }
                                        selectElm.options[selectElm.options.length] = new Option(selectText, selectValue);
                                    }
                                }
                                if (currentSelectedVal == 0) {
                                    selectElm.selectedIndex = 0;
                                } else {
                                    selectElm.value = currentSelectedVal;
                                }
                                triggerEvent(targetSelectElmId, 'change');

                                if (typeof successCallback === "function") {
                                    successCallback();
                                }
                            }
                        }
                    }
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        let error = data.Error;
                        if (error) {
                            if (error.hasOwnProperty('Message') === true) {
                                showText(responseElm, error.Message, 'red');
                            }
                        }
                    }
                });
        }

        return false;
    }

    function refreshViewComponentHierarchy(progressElmId, sourceComponentId, targetSelectElmId)
    {
        getViewComponentHierarchy(progressElmId, 'copyComponentSourceResponse', sourceComponentId, targetSelectElmId, function () {

        });
    }

    function fillSubComponentList(componentSelectElmId, subComponentSelectElmId)
    {
        let subComponentSelectElm = getElm(subComponentSelectElmId);
        if (subComponentSelectElm) {
            subComponentSelectElm.options.length = 0;

            let componentSelectElm = getElm(componentSelectElmId);
            if (componentSelectElm) {

                let selectedValue = componentSelectElm.value;
                let idxOfColon = selectedValue.indexOf(":");
                let selectedDepth = selectedValue.substring(0, idxOfColon);
                let childDepth = parseInt(selectedDepth) + 1;

                let idxOfSemiColon = selectedValue.indexOf(";");
                let selectedComponent = selectedValue.substring(idxOfSemiColon + 1);

                if (selectedComponent == "HTMLPLACEHOLDER") {
                    selectedComponent = selectedValue.substring(0, idxOfSemiColon);
                    let idxOfColonSelected = selectedComponent.indexOf(":");
                    selectedDepth = selectedComponent.substring(0, idxOfColon);
                    childDepth = parseInt(selectedDepth);
                    selectedComponent = selectedComponent.substring(idxOfColonSelected + 1);
                }

                for (let i = 0; i < componentSelectElm.options.length; i++) {
                    let selectVal = componentSelectElm.options[i].value;

                    if ((selectVal.startsWith((childDepth - 1)) == true) && (selectVal.endsWith(selectedComponent) == true))
                    {
                        componentSelectElm.value = selectVal;
                    }
                    if (selectVal.startsWith(childDepth + ":" + selectedComponent) == true) {

                        let selectText = componentSelectElm.options[i].text;
                        let selectValue = componentSelectElm.options[i].value;

                        subComponentSelectElm.options[subComponentSelectElm.options.length] = new Option(selectText, selectValue);
                    }
                }
            }
        }
    }

    function getViewComponentCategoryList(progressElmId, responseElmId, newComponentAppSiteVal, selectElmId, successCallback) {

        let id = window.ajaxid++;
        let responseContainerElmId = responseElmId + "Container";
        let responseElm = getElm(responseElmId);
        while (responseElm.firstChild) responseElm.removeChild(responseElm.firstChild);
        let responseContainerElm = getElm(responseContainerElmId)
        hideElm(responseContainerElmId);

        let valid = true;

        if (valid === true) {

            let url = '/AppApi/VueApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'GetViewComponentCategoryList',
                "params": {
                    "componentAppSite": newComponentAppSiteVal,
                    "skipValue": "",
                    "selectEmptyText": "No Component Category Found",
                    "selectedKey": "Intro",
                    "appendOptionText": "",
                    "appendOptionValue": ""
                },
                "id": id
            };

            let selectElm = getElm(selectElmId);
            if (selectElm) {
                selectElm.options.length = 0;
            }

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (((data.hasOwnProperty('Result') === true) && (data.Result)) && (data.Result)) {
                        let result = data.Result;
                        if (result.hasOwnProperty('html') === true) {
                            let rootNode = getElm(selectElmId);
                            rootNode.innerHTML = result.html;

                            if (typeof successCallback === "function") {
                                successCallback();
                            }
                        }
                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                        //else if (result.hasOwnProperty('message') === true) {
                        //    showText(responseElm, result.message, 'green');
                        //}
                    }
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        let error = data.Error;
                        if (error) {
                            if (error.hasOwnProperty('Message') === true) {
                                showText(responseElm, error.Message, 'red');
                            }
                        }
                    }
                });
        }

        return false;
    }

    function getViewComponentList(progressElmId, responseElmId, newComponentAppSiteVal, newComponentCategoryVal, selectElmId, successCallback) {

        let id = window.ajaxid++;
        let responseContainerElmId = responseElmId + "Container";
        let responseElm = getElm(responseElmId);
        while (responseElm.firstChild) responseElm.removeChild(responseElm.firstChild);
        let responseContainerElm = getElm(responseContainerElmId)
        hideElm(responseContainerElmId);

        let valid = true;

        if (valid === true) {

            let url = '/AppApi/VueApi';
            let urlMethod = 'POST';
            let urlContent = {
                "jsonrpc": '2.0', "method": 'GetViewComponentList',
                "params": {
                    "componentAppSite": newComponentAppSiteVal,
                    "componentCategory": newComponentCategoryVal
                },
                "id": id
            };

            let selectElm = getElm(selectElmId);
            if (selectElm) {
                selectElm.options.length = 0;
            }

            dopost(progressElmId, responseElmId, url, urlContent,
                function (data) {
                    if (((data.hasOwnProperty('Result') === true) && (data.Result)) && (data.Result)) {
                        let result = data.Result;

                        if (result.hasOwnProperty('error') === true) {
                            showText(responseElm, result.error, 'red');
                        }
                        else if (result.hasOwnProperty('message') === true) {
                            //showText(responseElm, result.message, 'green');

                            if (result.hasOwnProperty('json') === true) {
                                let json = result.json;

                                let selectElm = getElm(selectElmId);
                                if (selectElm) {
                                    selectElm.options.length = 0;

                                    for (let i = 0; i < json.length; i++) {
                                        let jsonSource = json[i];

                                        let selectText = "";
                                        let selectValue = "";
                                        for (let key in jsonSource) {
                                            selectText = jsonSource[key];
                                            selectValue = key;
                                        }
                                        selectElm.options[selectElm.options.length] = new Option(selectText, selectValue);
                                    }
                                }
                                selectElm.selectedIndex = 0;

                                if (typeof successCallback === "function") {
                                    successCallback();
                                }
                            }
                        }
                    }
                    if ((data.hasOwnProperty('Error') === true) && (data.Error)) {
                        let error = data.Error;
                        if (error) {
                            if (error.hasOwnProperty('Message') === true) {
                                showText(responseElm, error.Message, 'red');
                            }
                        }
                    }
                });
        }

        return false;
    }

</script>

<input type="hidden" class="border" style="width:100%;" id="copyComponentAppSite" value="{{$AppSite}}" />
<input type="hidden" class="border" style="width:100%;" id="copyComponentAppView" value="{{$AppView}}" />

<div style="position:relative;text-align:center;height:0px;">
    <div id="copyComponentSourceProgress"></div>
</div>
<div class="notification is-marginless" id="copyComponentSourceResponseContainer" style="display:none;">
    <button class="delete" onclick="hideElm('copyComponentSourceResponseContainer');"></button>
    <div id="copyComponentSourceResponse"></div>
</div>

<div class="modal" id="copyComponentSource">
    <div class="modal-background"></div>
    <div class="modal-content" style="background-color:#fff;">

        <div class="flex-content-wrap">
            <button class="flex-item-stretch">Copy Component to Hierarchy</button>
            <button class="border" style="margin-top: 7px; width: 25px; height: 25px;" onclick="hideComponentSourceCopy()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <div style="padding:3px 10px;text-align:center;margin:5px 10px;" class="border">

            <div class="flex-content-wrap" style="padding:3px 10px;display:none;">
                <div class="flex-item-stretch border" style="height:40px;">
                    <input type="text" class="flex-item-stretch" style="width:100%;border:none;" id="sourceComponentId" readonly />
                </div>
            </div>

            <div class="flex-content-wrap" style="padding:3px 10px;">
                <label style="width:100%;" id="sourceComponentTitle">Components</label>
                <div class="flex-item-stretch border-left" style="height:40px;">
                    <select id="selectMainComponent" style="width:100%;" placeholder="Select Component" onchange="fillSubComponentList('selectMainComponent', 'selectSubComponent');">
                        <option value="0">Select Main Component</option>
                    </select>
                </div>
                <button class="border-right" style="width:40px;height:40px;" id="refreshMainComponentListBtn" onclick="refreshViewComponentHierarchy('copyMainComponentListProgress', getElm('sourceComponentId').value, 'selectMainComponent');">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <div id="copyMainComponentListProgress"></div>
                </button>
            </div>

            <div class="flex-content-wrap" style="padding:3px 10px;">
                <div style="width:100%;text-align:center;">
                    <label style="text-align:center;display:inline-block;">
                        <input type="radio"
                               name="addBeforeComponent"
                               value="true"
                               checked="checked">&nbsp;Add Before Or
                    </label>
                    <label style="text-align:center;display:inline-block;">
                        <input type="radio"
                               name="addBeforeComponent"
                               value="false">&nbsp;After
                    </label>
                    <label>Sub Component</label>
                </div>
                <select id="selectSubComponent" class="border flex-item-stretch" style="width:100%;" placeholder="Select Component">
                    <option>Select Sub Component</option>
                </select>
                <label style="width:100%;font-size:xx-small;color:red;">Select Placeholder to add or Component to replace</label>
            </div>

        </div>

        <div style="padding:3px 10px;text-align:center;margin:5px 10px;" class="border">

            <div class="flex-content-wrap" style="padding:0px 10px;">
                <label style="width:100%;">Component App Site</label>
                <div class="flex-item-stretch border-left" style="height:40px;">
                    <select style="width:100%;border:none;" id="selectNewComponentAppSite" onchange="getViewComponentCategoryList('copyComponentListProgress', 'copyResponse', getElm('selectNewComponentAppSite').value, 'selectNewComponentCategory');">
                        {{
                            VIEW_AppSiteSelect(
                            "AppSiteList",
                            "AppSite":"{$AppSite}",
                            "SkipValue" : "",
                            "FilterValue": "",
                            "SelectedKey":"Index",
                            "SelectEmptyText":"No App Site Found",
                            "AppendOption" : "",
                            "AppendOptionValue" : "")
                        }}
                    </select>
                </div>
                <button class="border-right" style="width:40px;height:40px;" id="refreshComponentCategoryListBtn" onclick="getViewComponentCategoryList('copyComponentListProgress', 'copyResponse', getElm('selectNewComponentAppSite').value, 'selectNewComponentCategory');">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <div id="copyComponentListProgress"></div>
                </button>
            </div>

            <div class="flex-content-wrap" style="padding:0px 10px;">
                <label style="width:100%;">Component Category</label>
                <div class="flex-item-stretch border-left" style="height:40px;">
                    <select style="width:100%;border:none;" id="selectNewComponentCategory" onchange="getViewComponentList('copyComponentCategoryListProgress', 'copyResponse', getElm('selectNewComponentAppSite').value, getElm('selectNewComponentCategory').value, 'selectNewComponent');">
                        {{
                            VIEW_ComponentCategorySelect(
                            "ComponentCategoryList",
                            "SkipValue" : "",
                            "FilterValue": "Index",
                            "SelectedKey":"Intro",
                            "SelectEmptyText":"No Component Category Found",
                            "AppendOption" : "",
                            "AppendOptionValue" : "")
                        }}
                    </select>
                </div>
                <button class="border-right" style="width:40px;height:40px;" id="refreshComponentListBtn" onclick="getViewComponentList('copyComponentCategoryListProgress', 'copyResponse', getElm('selectNewComponentAppSite').value, getElm('selectNewComponentCategory').value, 'selectNewComponent');">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    <div id="copyComponentCategoryListProgress"></div>
                </button>
            </div>

            <div class="flex-content-wrap" style="padding:0px 10px;">
                <label style="width:100%;">New Component</label>
                <div class="flex-item-stretch border" style="height:40px;">
                    <select id="selectNewComponent" style="width:100%;" placeholder="Select New Component">
                        <option>Select New Component</option>
                    </select>
                </div>
            </div>

        </div>

        <div style="padding:3px 10px;text-align:center;margin:5px 10px;" class="border">

            <div class="flex-content-wrap" style="margin: 3px 5px;">
                <label style="margin: 0px 5px;">
                    <input type="checkbox" id="addAsCopyComponent" checked="checked">&nbsp;Add As Copy Component
                </label>
                <label style="margin: 0px 5px;">
                    <input type="checkbox" id="addAsViewComponent" disabled="disabled">&nbsp;Add As ViewID Component
                </label>
                <label style="margin: 0px 5px;">
                    <input type="checkbox" id="replaceComponent">&nbsp;Replace Component
                </label>
                <label style="margin: 0px 5px;">
                    <input type="checkbox" id="encloseComponent" disabled="disabled">&nbsp;Enclose Component
                </label>
            </div>


            <div class="flex-content-wrap" style="margin: 3px 0px;">

                <button class="border button" style="background-color:#209cee;margin-right:5px;"
                        onclick="addViewComponent('copyAddComponentProgress', 'copyResponse',
                            getElm('copyComponentAppSite').value, getElm('copyComponentAppView').value, getElm('selectMainComponent').value, getElm('selectSubComponent').value,
                            getElm('selectNewComponentAppSite').value, getElm('selectNewComponent').value, getCheckedElmByName('addBeforeComponent').value, getElm('addAsCopyComponent').checked, getElm('replaceComponent').checked, {},
                            false, '', '', function () { triggerEvent('refreshMainComponentListBtn', 'click'); });">
                    Add Component <div id="copyAddComponentProgress"></div>
                </button>

                <button class="border button" style="background-color:red;margin-right:5px;"
                        onclick="deleteViewComponent('copyDeleteComponentProgress', 'copyResponse',
                        getElm('copyComponentAppSite').value, getElm('copyComponentAppView').value, getElm('selectMainComponent').value,
                        getElm('selectSubComponent').value, {},
                        false, '', '', function () { triggerEvent('refreshMainComponentListBtn', 'click'); });">
                    Delete Component <div id="copyDeleteComponentProgress"></div>
                </button>

            </div>

            <div class="notification" id="copyResponseContainer" style="margin:3px; padding:5px 10px;text-align:justify;display:none;width:100%;">
                <button class="delete" onclick="hideElm('copyResponseContainer')"></button>
                <div id="copyResponse"></div>
            </div>

        </div>

    </div>
</div>

