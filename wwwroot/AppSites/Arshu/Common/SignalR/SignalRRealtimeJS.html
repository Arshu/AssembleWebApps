<script type="text/javascript">

    const globalWebSocketTimeout = 10000;

    let globalWebSocketConnection;

    const url = new URL(document.location);
    const keepAliveInterval = 1000 * parseInt('{{$KeepAliveInterval}}'); // 15 Seconds
    const serverTimeout = 1000 * parseInt('{{$ServerTimeout}}'); // 60 Seconds
    let signalRUrl = "/{{$ApiHub}}";

    const urlParams = url.searchParams;
    const region = urlParams.get('region');
    const instance = urlParams.get('instance');
    const appname = urlParams.get('app');

    if ((region) && (region.length > 0)) {
        var regionUrl = new URL(signalRUrl, document.baseURI);
        if (regionUrl.searchParams.has('region') == false) {
            regionUrl.searchParams.append('region', region);
            signalRUrl = regionUrl.toString();
            console.log('region Url:', signalRUrl);
        }
    }
    else if ((instance) && (instance.length > 0)) {
        var instanceUrl = new URL(signalRUrl, document.baseURI);
        if (instanceUrl.searchParams.has('instance') == false) {
            instanceUrl.searchParams.append('instance', instance);
            signalRUrl = instanceUrl.toString();
            console.log('instance Url:', signalRUrl);
        }
    }
    else if ((appname) && (appname.length > 0)) {
        var appnameUrl = new URL(signalRUrl, document.baseURI);
        if (appnameUrl.searchParams.has('app') == false) {
            appnameUrl.searchParams.append('app', appname);
            appnameUrl = appnameUrl.toString();
            console.log('app Url:', signalRUrl);
        }
    }
    const folder = urlParams.get('folder');
    if ((folder) && (folder.length > 0)) {
        var folderUrl = new URL(signalRUrl, document.baseURI);
        if (folderUrl.searchParams.has('folder') == false) {
            folderUrl.searchParams.append('folder', folder);
            signalRUrl = folderUrl.toString();
            console.log('Folder Url:', signalRUrl);
        }
    }

    const signalRConnection = new signalR.HubConnectionBuilder()
        .withUrl(signalRUrl)
        .build();

    signalRConnection.keepAliveIntervalInMilliseconds = keepAliveInterval
    signalRConnection.serverTimeoutInMilliseconds = serverTimeout

    const startWebSocketConnection = signalRConnection => signalRConnection.start()
        .then(() => {
            globalWebSocketConnection = signalRConnection;
            //console.info('Websocket Connection Established [' + signalRConnection.state + "] with KeepAlive Interval [" + signalRConnection.keepAliveIntervalInMilliseconds + "] and Server Timeout [" + signalRConnection.serverTimeoutInMilliseconds + "]");
            if (signalRConnection.state == "Connected") {
                callChangeContextPage("{{$AppSite}}", "{{$AppView}}");
            }
        })
        .catch(err => {
            console.log('Client Websocket Connection Error: ', err);
            globalWebSocketActive = false;
            globalWebSocketConnection = null;
            lastAppSite = "";
            lastAppView = "";
        });

    startWebSocketConnection(signalRConnection);

    signalRConnection.onclose(() => {
        globalWebSocketActive = false;
        globalWebSocketConnection = null;
        lastAppSite = "";
        lastAppView = "";
        //console.log('Client Websocket Connection Close');
    });

    signalRConnection.on("WebSocketCountChange", onSetOnlineCount);

    signalRConnection.on("PageChange", onPageChanged);

    signalRConnection.on("RefreshView", onRefreshView);

    function restartWebSocketConnection() {
        if ((globalWebSocketActive == false) && (globalWebSocketConnection)) {
            //console.log('Restarting WebSocket Connection');
            startWebSocketConnection(signalRConnection);
        }
    }




    let lastAppSite = "";
    let lastAppView = "";
    function callChangeContextPage(appSite, appView) {
        if ((globalWebSocketConnection) && (globalWebSocketConnection.state == "Connected")) {
            if ((lastAppSite != appSite) || (lastAppView != appView)) {
                lastAppSite = appSite;
                lastAppView = appView;
                let appDomain = window.location.hostname;
                globalWebSocketConnection.invoke('CallChangeContextPage', appDomain + "," + appSite + "," + appView);
                //console.log('Invoked ChangeContextPage: ' + appDomain + "," + appSite + "," + appView);
            }
        }
    }

    function callWSApi(progressElmId, responseElmId, apiUrl, apiMethod, apiParams, successCallback, failureCallback, clientRequestStartTimestamp) {
        if ((globalWebSocketActive == true) && (globalWebSocketConnection) && (globalWebSocketConnection.state == "Connected")) {
            ajaxStart(progressElmId);

            let appDomain = window.location.hostname;
            let rootPort = window.location.port;
            let isSecure = true;
            if (location.protocol !== 'https:') {
                isSecure = false;
            }
            if (rootPort.trim() == "") {
                if (isSecure == true) { rootPort = "443"; } else { rootPort = "80"; }
            }
            var currentAppSite = "";
            if (apiParams.hasOwnProperty("appSite") == true) {
                currentAppSite = apiParams["appSite"];
            }
            if (apiParams.hasOwnProperty("appsite") == true) {
                currentAppSite = apiParams["appsite"];
            }
            var currentAppView = "";
            if (apiParams.hasOwnProperty("appView") == true) {
                currentAppView = apiParams["appView"];
            }
            if (apiParams.hasOwnProperty("appview") == true) {
                currentAppView = apiParams["appview"];
            }

            if (apiParams.hasOwnProperty("isRealtime") == true) {
                var refreshAppDomain = "";
                if (apiParams.hasOwnProperty("refreshAppDomain") == true) {
                    refreshAppDomain = apiParams["refreshAppDomain"];
                }
                if (refreshAppDomain == "") {
                    apiParams["isRealtime"] = false;
                }
            }
            let requestToken = document.head.querySelector("[name=REQUESTTOKEN]").content;
            if (!clientRequestStartTimestamp) {
                clientRequestStartTimestamp = Math.floor(new Date().getTime());
            }

            let webSocketTimeout = 10000;
            if (typeof globalWebSocketTimeout !== 'undefined') {
                webSocketTimeout = globalWebSocketTimeout;
            }

            wrapPromise(globalWebSocketConnection.invoke('CallWSApi', isSecure, requestToken, appDomain, parseInt(rootPort), apiUrl, apiMethod, apiParams, clientRequestStartTimestamp), webSocketTimeout, { reason: 'Web Socket Connection timed out' })
                .then((returnJson) => {
                    if (returnJson) {
                        ajaxStop(returnJson, progressElmId, false);
                        filterShowWSTime(returnJson, false);

                        if (typeof successCallback === "function") {
                            successCallback(returnJson);
                        }
                    } else {
                        showText(responseElm, 'Web Socket Connection Not Available', 'red');
                    }
                })
                .catch((returnJson) => {
                    if (returnJson) {
                        if (data.hasOwnProperty("reason") == true) {
                            showText(responseElm, returnJson.reason, 'red');
                        } else {
                            showText(responseElm, 'Exception Web Socket Connection Not Available', 'red');
                        }
                    } else {
                        showText(responseElm, 'Exception Web Socket Connection Not Available', 'red');
                    }
                });

        }
    }

    function onSetOnlineCount(onlineCount, connectionInfo)
    {
        //console.log('WebSocket Count: [' + connectionInfo + "]" + onlineCount);
        getElm('webSocketCount').textContent = onlineCount;
    }

    function onPageChanged(pageChangeInfo, connectionInfo) {
        //console.log('PageChanged: [' + connectionInfo + "]" + pageChangeInfo);
        globalWebSocketActive = true;
    }

    function onRefreshView(jsonMessage, connectionInfo) {
        filterShowWSTime(jsonMessage, false);

        let changedAppSite = "";
        if (jsonMessage.hasOwnProperty('ChangedAppSite') === true) {
            changedAppSite = jsonMessage['ChangedAppSite'];
        }
        let changedAppView = "";
        if (jsonMessage.hasOwnProperty('ChangedAppView') === true) {
            changedAppView = jsonMessage['ChangedAppView'];
        }
        let changedPageNameOrPath = "";
        if (jsonMessage.hasOwnProperty('ChangedPageNameOrPath') === true) {
            changedPageNameOrPath = jsonMessage['ChangedPageNameOrPath'];
        }
        
        if (jsonMessage.hasOwnProperty('ChangedJson') == true) {

            let clientRequestStartTimestamp = 0;
            if (jsonMessage.hasOwnProperty('ClientRequestStartTimestamp') === true) {
                clientRequestStartTimestamp = jsonMessage['ClientRequestStartTimestamp'];
            }

            let serverRequestStartTimestamp = 0;
            if (jsonMessage.hasOwnProperty('ServerRequestStartTimestamp') === true) {
                serverRequestStartTimestamp = jsonMessage['ServerRequestStartTimestamp'];
            }

            let serverRequestEndTimestamp = 0;
            if (jsonMessage.hasOwnProperty('ServerRequestEndTimestamp') === true) {
                serverRequestEndTimestamp = jsonMessage['ServerRequestEndTimestamp'];
            }

            let currentTimestamp = Math.floor(new Date().getTime());
            let clientRequestTimestampDifference = currentTimestamp - clientRequestStartTimestamp;

            let serverRequestTimestampDifference = (serverRequestEndTimestamp - serverRequestStartTimestamp);
            let networkTimestampDifference = clientRequestTimestampDifference - serverRequestTimestampDifference;

            console.log('WSRefreshView [' + connectionInfo + '] With Changed Json [' + clientRequestTimestampDifference + 'ms][' + serverRequestTimestampDifference + 'ms]');

            let jsonTagList = jsonMessage.ChangedJson;
            refreshViewComponentJson(jsonTagList);
            setMetrics(jsonMessage);

            if (typeof callChangeContextPage === "function") {
                if ((changedAppSite != "") && (changedAppView != "")) {
                    callChangeContextPage(changedAppSite, changedAppView);
                }
            }

        } else {
            console.log(`WSRefreshView With AppSite ${currentAppSite}, AppView ${currentAppView} and PageNameOrPath ${changedPageNameOrPath}`);

            if ((currentAppSite.length > 0) && (currentAppView.length > 0) && (changedPageNameOrPath.length > 0)) {
                refreshViewComponentHtml('progress', 'response', currentAppSite, currentAppView, changedPageNameOrPath, {}, false, false, '', '')
            }
        }
    }



  
    let showLastWebSocketCount = 7;

    function filterShowWSTime(serverResponseJson) {
        if ((serverResponseJson) && (serverResponseJson.ServiceInfo)) {
            if ((serverResponseJson.ServiceInfo.toUpperCase().indexOf("ServerApi".toUpperCase()) === -1)
                && (serverResponseJson.ServiceInfo.toUpperCase().indexOf("CurlApi".toUpperCase()) === -1)
            ) {
                recordWSTiming(serverResponseJson, false);
            }
        } else {
            recordWSTiming(serverResponseJson, false);
        }
    }

    function recordWSTiming(returnWsJson, clear) {
        if (haveElm('wsTime') == true) {
            let wsTimeElm = getElm('wsTime');
            if (wsTimeElm) {

                let currentTimestamp = Math.floor(new Date().getTime());
                let wsTimeVal = "";
                if (clear === true) wsTimeElm.innerHTML = "";

                if (returnWsJson.hasOwnProperty('ClientRequestStartTimestamp') === true) {

                    let clientRequestStartTimestamp = returnWsJson['ClientRequestStartTimestamp'];
                    let clientRequestTimestampDifference = 0;
                    if (clientRequestStartTimestamp > 0) {
                        clientRequestTimestampDifference = currentTimestamp - clientRequestStartTimestamp;
                    }

                    let serverRequestStartTimestamp = 0;
                    if (returnWsJson.hasOwnProperty('ServerRequestStartTimestamp') === true) {
                        serverRequestStartTimestamp = returnWsJson['ServerRequestStartTimestamp'];
                    }

                    let serverRequestEndTimestamp = currentTimestamp;
                    if (returnWsJson.hasOwnProperty('ServerRequestEndTimestamp') === true) {
                        serverRequestEndTimestamp = returnWsJson['ServerRequestEndTimestamp'];
                    }

                    let serverRequestTimestampDifference = (serverRequestEndTimestamp - serverRequestStartTimestamp);
                    let networkTimestampDifference = clientRequestTimestampDifference - serverRequestTimestampDifference;

                    if (clientRequestTimestampDifference > 0) {
                        if ((serverRequestTimestampDifference <= 0) && (clientRequestTimestampDifference != serverRequestTimestampDifference)) {
                            wsTimeVal = "(<span style='color:red;'>" + clientRequestTimestampDifference + "</span>)";
                            if (returnWsJson.hasOwnProperty('ServiceInfo') === true) {
                                wsTimeVal = "(<span style='color:red;' title='" + returnWsJson.ServiceInfo + "'>" + clientRequestTimestampDifference + "</span >)";
                                if (typeof sendWSMetrics === "function") {
                                    sendWSMetrics(returnWsJson.ServiceInfo, serverRequestTimestampDifference, clientRequestTimestampDifference);
                                }
                            }
                        } else {
                            wsTimeVal = "(<span style='color:red;'>" + clientRequestTimestampDifference + "[" + serverRequestTimestampDifference + "]</span>)";
                            if (returnWsJson.hasOwnProperty('ServiceInfo') === true) {
                                wsTimeVal = "(<span style='color:red;' title='" + returnWsJson.ServiceInfo + "'>" + clientRequestTimestampDifference + "[" + serverRequestTimestampDifference + "]</span>)";
                                if (typeof sendWSMetrics === "function") {
                                    sendWSMetrics(returnWsJson.ServiceInfo, serverRequestTimestampDifference, clientRequestTimestampDifference);
                                }
                            }
                        }
                    } else {
                        if (serverRequestTimestampDifference > 0) {
                            wsTimeVal = "(<span style='color:red;'>[" + serverRequestTimestampDifference + "]</span>)";
                            if (returnWsJson.hasOwnProperty('ServiceInfo') === true) {
                                wsTimeVal = "(<span style='color:red;' title='" + returnWsJson.ServiceInfo + "'>[" + serverRequestTimestampDifference + "]</span>)";
                                if (typeof sendWSMetrics === "function") {
                                    sendWSMetrics(returnWsJson.ServiceInfo, serverRequestTimestampDifference, clientRequestTimestampDifference);
                                }
                            }
                        }
                    }
                } else {
                    if (returnWsJson.hasOwnProperty('ServerRequestStartTimestamp') === true)
                    {
                        let serverRequestStartTimestamp = 0;
                        if (returnWsJson.hasOwnProperty('ServerRequestStartTimestamp') === true) {
                            serverRequestStartTimestamp = returnWsJson['ServerRequestStartTimestamp'];
                        }

                        let serverRequestEndTimestamp = currentTimestamp;
                        if (returnWsJson.hasOwnProperty('ServerRequestEndTimestamp') === true) {
                            serverRequestEndTimestamp = returnWsJson['ServerRequestEndTimestamp'];
                        }

                        let serverRequestTimestampDifference = (serverRequestEndTimestamp - serverRequestStartTimestamp);

                        if (serverRequestTimestampDifference > 0) {
                            wsTimeVal = "(<span style='color:red;'>[" + serverRequestTimestampDifference + "]</span>)";
                            if (returnWsJson.hasOwnProperty('ServiceInfo') === true) {
                                wsTimeVal = "(<span style='color:red;' title='" + returnWsJson.ServiceInfo + "'>[" + serverRequestTimestampDifference + "]</span>)";
                                if (typeof sendWSMetrics === "function") {
                                    sendWSMetrics(returnWsJson.ServiceInfo, serverRequestTimestampDifference, clientRequestTimestampDifference);
                                }
                            }
                        }
                    }
                }

                if (wsTimeVal.length > 0) {
                    let wsTimeElmText = wsTimeElm.innerHTML.trim();
                    let storedWsTime = sessionStorage.getItem('wsTime');
                    if (storedWsTime !== null) {
                        if (storedWsTime.length > 0) {
                            wsTimeElmText = storedWsTime;
                        }
                    }

                    let wsTimeList = "";
                    if (wsTimeElmText.length === 0) {
                        wsTimeList = wsTimeVal;
                    }
                    else {

                        if (wsTimeElmText.indexOf(",") === -1) {
                            wsTimeList = wsTimeElmText + "," + wsTimeVal;
                        } else {
                            let wsTimeArr = wsTimeElmText.split(",", showLastWebSocketCount);
                            if (wsTimeArr.length >= showLastWebSocketCount) wsTimeArr.shift();
                            wsTimeList = wsTimeArr.join(",") + "," + wsTimeVal;
                        }
                    }
                    wsTimeElm.innerHTML = "WS[" + wsTimeList + "]";
                    sessionStorage.setItem("wsTime", wsTimeList);
                }
            }
        }
    }

    function clearWSTiming() {
        if (haveElm('wsTime') == true) {
            let wsTimeElm = getElm('wsTime');
            if (wsTimeElm) {
                wsTimeElm.innerHTML = "";
            }
        }
        sessionStorage.setItem("wsTime", "");
    }

</script>
